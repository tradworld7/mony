<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same until the script section -->
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBshAGZScyo7PJegLHMzORbkkrCLGD6U5s",
            authDomain: "mywebsite-600d3.firebaseapp.com",
            databaseURL: "https://mywebsite-600d3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywebsite-600d3",
            storageBucket: "mywebsite-600d3.firebasestorage.app",
            messagingSenderId: "584485288598",
            appId: "1:584485288598:web:01856eaa18ba5ada49e0b7",
            measurementId: "G-GQ9J9QH42J"
        };

        const ADMIN_USER_ID = "KtdjLWRdN5M5uOA1xDokUtrxfe93";

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const database = firebase.database();
        const { jsPDF } = window.jspdf;

        let currentUser = null;
        let userData = null;

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // Load user data
        function loadUserData(uid) {
            const userRef = database.ref('users/' + uid);
            
            userRef.on('value', (snapshot) => {
                userData = snapshot.val();
                
                if (userData) {
                    // Update modal balance display
                    document.getElementById("modalBalance").textContent = userData.balance ? userData.balance.toFixed(2) : "0.00";
                }
            }, (error) => {
                console.error("Error loading user data:", error);
                showToast("Error loading data. Please refresh the page.", "error");
            });
        }

        // Purchase package function
        async function purchasePackage(packageAmount, packageName) {
            if (!currentUser || !userData) {
                showToast("Please login first", "error");
                return false;
            }

            packageAmount = parseFloat(packageAmount);
            if (isNaN(packageAmount) || packageAmount <= 0) {
                showToast("Invalid package amount", "error");
                return false;
            }

            if ((userData.balance || 0) < packageAmount) {
                showToast("Insufficient balance", "error");
                return false;
            }

            try {
                // Create invoice
                const invoiceId = database.ref().child('invoices').push().key;
                const purchaseDate = new Date().toISOString();
                const maturityDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
                
                const invoiceData = {
                    invoiceId,
                    userId: currentUser.uid,
                    amount: packageAmount,
                    expectedReturn: packageAmount * 2,
                    purchaseDate,
                    maturityDate,
                    status: 'active',
                    packageName: packageName
                };
                
                // Calculate commissions
                const adminCommission = packageAmount * 0.10;
                const directReferralCommission = packageAmount * 0.10;
                const levelCommissions = packageAmount * 0.08; // 2% each for 4 levels
                const tradingPool = packageAmount * 0.72;
                
                // Prepare all updates
                const updates = {};
                
                // 1. Deduct from user balance
                updates[`users/${currentUser.uid}/balance`] = (userData.balance || 0) - packageAmount;
                
                // 2. Add to investments
                updates[`users/${currentUser.uid}/investments/${invoiceId}`] = {
                    amount: packageAmount,
                    purchaseDate: purchaseDate,
                    status: 'active',
                    expectedReturn: packageAmount * 2,
                    maturityDate: maturityDate
                };
                
                // 3. Add invoice
                updates[`users/${currentUser.uid}/invoices/${invoiceId}`] = invoiceData;
                updates[`invoices/${invoiceId}`] = invoiceData;
                
                // 4. Add transaction record
                const transactionId = database.ref().child('transactions').push().key;
                updates[`transactions/${transactionId}`] = {
                    type: 'investment',
                    amount: packageAmount,
                    status: 'completed',
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    details: `Purchased ${packageName} package`
                };
                updates[`users/${currentUser.uid}/transactions/${transactionId}`] = {
                    type: 'investment',
                    amount: packageAmount,
                    status: 'completed',
                    timestamp: Date.now(),
                    details: `Purchased ${packageName} package`
                };
                
                // 5. Add admin commission (10%)
                updates[`users/${ADMIN_USER_ID}/tradingProfit`] = firebase.database.ServerValue.increment(adminCommission);
                updates[`system/adminEarnings`] = firebase.database.ServerValue.increment(adminCommission);
                
                // 6. Process referral commissions (if any)
                if (userData.referredBy) {
                    await handleReferralCommissions(userData.referredBy, currentUser.uid, packageAmount, updates);
                }
                
                // 7. Add to trading pool (72%)
                updates[`system/tradingPool`] = firebase.database.ServerValue.increment(tradingPool);
                
                // Execute all updates
                await database.ref().update(updates);
                
                showToast(`${packageName} purchased successfully! Invoice generated.`, "success");
                
                // Close modal
                document.getElementById("packageModal").classList.remove("open");
                
                // Reset modal
                document.getElementById("confirmPassword").value = '';
                
                // Update balance display
                document.getElementById("modalBalance").textContent = ((userData.balance || 0) - packageAmount).toFixed(2);
                
                return true;
                
            } catch (error) {
                console.error("Package purchase error:", error);
                showToast("Failed to purchase package", "error");
                return false;
            }
        }

        // Handle referral commissions
        async function handleReferralCommissions(referrerId, userId, packageAmount, updates) {
            try {
                // Get referrer data
                const referrerSnapshot = await database.ref(`users/${referrerId}`).once("value");
                const referrer = referrerSnapshot.val();
                
                if (!referrer) return;
                
                // Direct referral commission (10%)
                const directCommission = packageAmount * 0.10;
                updates[`users/${referrerId}/referralEarnings`] = 
                    firebase.database.ServerValue.increment(directCommission);
                
                updates[`users/${referrerId}/balance`] = 
                    firebase.database.ServerValue.increment(directCommission);
                    
                const directTxId = database.ref().child("transactions").push().key;
                updates[`users/${referrerId}/transactions/${directTxId}`] = {
                    type: "referral_commission",
                    amount: directCommission,
                    status: "completed",
                    timestamp: Date.now(),
                    details: `Direct referral commission from ${userId}`,
                    balanceBefore: referrer.balance || 0,
                    balanceAfter: (referrer.balance || 0) + directCommission
                };
                
                // Level commissions (2% each for levels 2-5)
                let currentUpline = referrer.referredBy;
                for (let level = 2; level <= 5; level++) {
                    if (!currentUpline) break;
                    
                    const levelCommission = packageAmount * 0.02;
                    
                    // Get upline data
                    const uplineSnapshot = await database.ref(`users/${currentUpline}`).once("value");
                    const upline = uplineSnapshot.val();
                    
                    if (upline) {
                        updates[`users/${currentUpline}/teamEarnings`] = 
                            firebase.database.ServerValue.increment(levelCommission);
                        
                        updates[`users/${currentUpline}/balance`] = 
                            firebase.database.ServerValue.increment(levelCommission);
                            
                        const levelTxId = database.ref().child("transactions").push().key;
                        updates[`users/${currentUpline}/transactions/${levelTxId}`] = {
                            type: "team_commission",
                            amount: levelCommission,
                            status: "completed",
                            timestamp: Date.now(),
                            details: `Level ${level} commission from ${userId}`,
                            balanceBefore: upline.balance || 0,
                            balanceAfter: (upline.balance || 0) + levelCommission
                        };
                        
                        // Update team structure counts
                        updates[`users/${currentUpline}/teamStructure/level${level}Count`] = 
                            firebase.database.ServerValue.increment(1);
                    }
                    
                    currentUpline = upline?.referredBy;
                }
                
            } catch (error) {
                console.error("Error handling referral commissions:", error);
            }
        }

        // Show toast notification
        function showToast(message, type = "success") {
            const toastContainer = document.getElementById("toastContainer");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
            
            toast.querySelector(".toast-close").addEventListener("click", () => {
                toast.remove();
            });
        }

        // Initialize sidebar toggle and logout
        window.addEventListener("DOMContentLoaded", () => {
            // Sidebar toggle for mobile
            document.getElementById("menuToggle").addEventListener("click", () => {
                document.getElementById("sidebar").classList.toggle("open");
            });
            
            // Package purchase buttons
            document.querySelectorAll('[data-package]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const packageAmount = parseFloat(this.getAttribute('data-package'));
                    const packageName = this.closest('.package-card').querySelector('.package-name').textContent;
                    
                    // Update modal with package details
                    document.getElementById("packageName").textContent = packageName;
                    document.getElementById("packagePrice").textContent = packageAmount;
                    document.getElementById("modalBalance").textContent = (userData?.balance || 0).toFixed(2);
                    
                    // Show warning if insufficient balance
                    const balanceWarning = document.getElementById("balanceWarning");
                    if ((userData?.balance || 0) < packageAmount) {
                        balanceWarning.style.display = "block";
                    } else {
                        balanceWarning.style.display = "none";
                    }
                    
                    // Show modal
                    document.getElementById("packageModal").classList.add("open");
                });
            });

            // Confirm purchase button
            document.getElementById("confirmPurchase").addEventListener("click", (e) => {
                e.preventDefault();
                
                const packageAmount = parseFloat(document.getElementById("packagePrice").textContent);
                const packageName = document.getElementById("packageName").textContent;
                const password = document.getElementById("confirmPassword").value;
                
                if (!password) {
                    showToast("Please enter your password", "error");
                    return;
                }
                
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    password
                );
                
                currentUser.reauthenticateWithCredential(credential)
                    .then(() => {
                        // Proceed with package purchase
                        purchasePackage(packageAmount, packageName);
                    })
                    .catch(error => {
                        console.error("Authentication failed:", error);
                        showToast("Authentication failed: " + error.message, "error");
                    });
            });

            // Close modal button
            document.getElementById("closePackageModal").addEventListener("click", () => {
                document.getElementById("packageModal").classList.remove("open");
                document.getElementById("confirmPassword").value = '';
                
                // Reset confirm button
                const confirmBtn = document.getElementById("confirmPurchase");
                confirmBtn.disabled = false;
                document.getElementById("confirmText").style.display = "inline-block";
                document.getElementById("confirmSpinner").style.display = "none";
            });

            // Logout button
            const logoutBtn = document.getElementById("logoutLink");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        window.location.href = "login.html";
                    }).catch((error) => {
                        console.error("Logout error:", error);
                        showToast("Error logging out. Please try again.", "error");
                    });
                });
            }
        });
    </script>
</head>
<!-- Rest of the body remains the same -->
