<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade World - My Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<script>
  // Firebase Config (apna config use karein)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>
<body>
    <!-- [Previous HTML structure remains exactly the same until the script section] -->

    <!-- Firebase and App Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let userData = {};
        let editingField = '';

        // [Keep all your helper functions like showToast, checkPasswordStrength]

        // MODIFIED loadUserData function
        function loadUserData(userId) {
            database.ref('users/' + userId).on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // Create user data if it doesn't exist
                    const newUserData = {
                        fullName: currentUser.displayName || "New User",
                        email: currentUser.email,
                        mobileNumber: "",
                        balance: 0,
                        joinDate: new Date().toISOString()
                    };
                    database.ref('users/' + userId).set(newUserData);
                    userData = newUserData;
                } else {
                    userData = snapshot.val();
                }
                
                // Update profile information
                document.getElementById('fullName').value = userData.fullName || '';
                document.getElementById('userEmail').value = currentUser.email || '';
                document.getElementById('mobileNumber').value = userData.mobileNumber || '';
                document.getElementById('userId').value = userId;
                document.getElementById('profileName').textContent = userData.fullName || 'User';
                
                // Format balance display
                const balance = userData.balance || 0;
                document.getElementById('headerBalance').textContent = balance.toFixed(2);
                
                // Set account creation date
                if (userData.joinDate) {
                    const createdDate = new Date(userData.joinDate);
                    document.getElementById('accountCreated').value = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                } else if (currentUser.metadata?.creationTime) {
                    const createdDate = new Date(currentUser.metadata.creationTime);
                    document.getElementById('accountCreated').value = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                }
                
                // Set referral link - FIXED THIS PART
                const baseUrl = "https://tradworld7.github.io/mony";
                document.getElementById('referralLink').value = `${baseUrl}/signup.html?ref=${userId}`;
                
                // Set avatar initials
                if (userData.fullName) {
                    const initials = userData.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                    document.getElementById('userAvatar').textContent = initials.substring(0, 2);
                }
            }, (error) => {
                showToast('Error loading user data: ' + error.message, 'error');
            });
        }

        // MODIFIED changePassword function
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('changePassText').style.display = 'none';
            document.getElementById('changePassSpinner').style.display = 'inline-block';
            document.getElementById('changePasswordBtn').disabled = true;
            
            // Create credentials with the user's email
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                currentPassword
            );
            
            // Reauthenticate and update password
            currentUser.reauthenticateWithCredential(credential)
                .then(() => {
                    return currentUser.updatePassword(newPassword);
                })
                .then(() => {
                    showToast('Password changed successfully!', 'success');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                })
                .catch(error => {
                    console.error('Password change error:', error);
                    let errorMessage = 'Password change failed.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Current password is incorrect';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'New password is too weak';
                    }
                    showToast(errorMessage, 'error');
                })
                .finally(() => {
                    // Reset button state
                    document.getElementById('changePassText').style.display = 'inline-block';
                    document.getElementById('changePassSpinner').style.display = 'none';
                    document.getElementById('changePasswordBtn').disabled = false;
                });
        }

        // MODIFIED updateProfileField function
        function updateProfileField(field, value) {
            if (!field || !value) {
                showToast('Invalid field or value', 'error');
                return;
            }
            
            document.getElementById('saveEditText').style.display = 'none';
            document.getElementById('saveEditSpinner').style.display = 'inline-block';
            document.getElementById('saveEditBtn').disabled = true;
            
            const updates = {};
            updates[field] = value;
            
            database.ref('users/' + currentUser.uid).update(updates)
                .then(() => {
                    showToast('Profile updated successfully!', 'success');
                    document.getElementById('editModal').classList.remove('open');
                    
                    // Update the displayed value immediately
                    if (field === 'fullName') {
                        document.getElementById('fullName').value = value;
                        document.getElementById('profileName').textContent = value;
                        // Update avatar initials
                        const initials = value.split(' ').map(n => n[0]).join('').toUpperCase();
                        document.getElementById('userAvatar').textContent = initials.substring(0, 2);
                    } else if (field === 'mobileNumber') {
                        document.getElementById('mobileNumber').value = value;
                    }
                })
                .catch(error => {
                    console.error('Update error:', error);
                    showToast('Error updating profile: ' + error.message, 'error');
                })
                .finally(() => {
                    document.getElementById('saveEditText').style.display = 'inline-block';
                    document.getElementById('saveEditSpinner').style.display = 'none';
                    document.getElementById('saveEditBtn').disabled = false;
                });
        }

        // [Keep all other functions the same]

        // MODIFIED DOM Content Loaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize auth state
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    loadUserData(user.uid);
                }
            });
            
            // [Keep all your event listeners the same]
            
            // Add this to ensure modal closes when clicking outside
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>
