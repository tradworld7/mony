<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains exactly the same] -->
</head>
<body>
    <!-- [Previous header and main content structure remains the same] -->

    <!-- Firebase and App Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase configuration (same as app.js)
        const firebaseConfig = {
            apiKey: "AIzaSyBshAGZScyo7PJegLHMzORbkkrCLGD6U5s",
            authDomain: "mywebsite-600d3.firebaseapp.com",
            databaseURL: "https://mywebsite-600d3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywebsite-600d3",
            storageBucket: "mywebsite-600d3.firebasestorage.app",
            messagingSenderId: "584485288598",
            appId: "1:584485288598:web:01856eaa18ba5ada49e0b7",
            measurementId: "G-GQ9J9QH42J"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let userData = null;
        let editingField = '';

        // Show toast notification
        function showToast(message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
            
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Load user data from Firebase
        function loadUserData(userId) {
            const userRef = database.ref('users/' + userId);
            
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    updateProfileUI(userId);
                } else {
                    // Initialize user data if not exists (should already exist from auth.js)
                    initializeUserData(userId);
                }
            }, (error) => {
                showToast('Error loading user data', 'error');
                console.error("Database error:", error);
            });
        }

        // Update profile UI with user data
        function updateProfileUI(userId) {
            if (!userData) return;

            // Basic info
            document.getElementById('fullName').value = userData.name || 'No Name';
            document.getElementById('userEmail').value = currentUser.email || '';
            document.getElementById('mobileNumber').value = userData.phoneNumber || '';
            document.getElementById('userId').value = userId;
            document.getElementById('profileName').textContent = userData.name || 'User';
            document.getElementById('profileEmail').textContent = currentUser.email || '';
            document.getElementById('profileBalance').value = `$${(userData.balance || 0).toFixed(2)}`;
            document.getElementById('headerBalance').textContent = (userData.balance || 0).toFixed(2);
            
            // Set account creation date
            document.getElementById('profileJoinDate').value = formatDate(userData.createdAt || currentUser.metadata.creationTime);
            
            // Set referral code (using user's UID if no referralId exists)
            const referralCode = userData.referralId || userId;
            document.getElementById('profileReferralCode').value = referralCode;
            
            // Set referral link (using your domain)
            const referralUrl = `${window.location.origin}/signup.html?ref=${referralCode}`;
            document.getElementById('referralLink').value = referralUrl;
            
            // Set avatar initials
            if (userData.name) {
                const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('userAvatar').textContent = initials.substring(0, 2);
            }
        }

        // Update profile field in Firebase
        async function updateProfileField(field, value) {
            if (!field || !value) {
                showToast('Please enter a valid value', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('saveEditText').style.display = 'none';
            document.getElementById('saveEditSpinner').style.display = 'inline-block';
            document.getElementById('saveEditBtn').disabled = true;
            
            try {
                const updates = {};
                
                if (field === 'mobileNumber') {
                    // Basic phone validation
                    if (!/^[\d\s\+\-\(\)]{8,15}$/.test(value)) {
                        throw new Error('Please enter a valid mobile number');
                    }
                    updates['phoneNumber'] = value;
                } 
                else if (field === 'fullName') {
                    updates['name'] = value;
                }
                
                // Update in Firebase
                await database.ref('users/' + currentUser.uid).update(updates);
                
                showToast('Profile updated successfully!', 'success');
                document.getElementById('editModal').classList.remove('open');
                
                // Update UI immediately
                document.getElementById(field).value = value;
                if (field === 'fullName') {
                    document.getElementById('profileName').textContent = value;
                    const initials = value.split(' ').map(n => n[0]).join('').toUpperCase();
                    document.getElementById('userAvatar').textContent = initials.substring(0, 2);
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('Error updating profile: ' + error.message, 'error');
            } finally {
                document.getElementById('saveEditText').style.display = 'inline-block';
                document.getElementById('saveEditSpinner').style.display = 'none';
                document.getElementById('saveEditBtn').disabled = false;
            }
        }

        // Change password function
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('changePassText').style.display = 'none';
            document.getElementById('changePassSpinner').style.display = 'inline-block';
            document.getElementById('changePasswordBtn').disabled = true;
            
            try {
                // Create credentials with the user's email
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    currentPassword
                );
                
                // Reauthenticate and update password
                await currentUser.reauthenticateWithCredential(credential);
                await currentUser.updatePassword(newPassword);
                
                showToast('Password changed successfully!', 'success');
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                console.error('Password change error:', error);
                let errorMessage = 'Password change failed.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'New password is too weak';
                }
                showToast(errorMessage, 'error');
            } finally {
                // Reset button state
                document.getElementById('changePassText').style.display = 'inline-block';
                document.getElementById('changePassSpinner').style.display = 'none';
                document.getElementById('changePasswordBtn').disabled = false;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize auth state
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    loadUserData(user.uid);
                }
            });
            
            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    const currentValue = document.getElementById(field).value;
                    
                    editingField = field;
                    document.getElementById('modalTitle').textContent = `Edit ${field === 'fullName' ? 'Full Name' : 'Mobile Number'}`;
                    document.getElementById('modalFieldLabel').textContent = field === 'fullName' ? 'Full Name' : 'Mobile Number';
                    document.getElementById('modalFieldInput').value = currentValue;
                    document.getElementById('modalFieldInput').focus();
                    
                    document.getElementById('editModal').classList.add('open');
                });
            });
            
            // Save edit button
            document.getElementById('saveEditBtn').addEventListener('click', function() {
                const newValue = document.getElementById('modalFieldInput').value.trim();
                if (newValue) {
                    updateProfileField(editingField, newValue);
                } else {
                    showToast('Please enter a valid value', 'error');
                }
            });
            
            // [Rest of the event listeners remain the same as before]
            
            // Copy referral link button
            document.getElementById('copyReferralBtn').addEventListener('click', function() {
                const referralInput = document.getElementById('referralLink');
                referralInput.select();
                document.execCommand('copy');
                showToast('Referral link copied to clipboard!', 'success');
            });
            
            // [Rest of the initialization code remains the same]
        });
    </script>
</body>
</html>
