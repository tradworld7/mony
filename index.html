<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same -->
    <!-- ... -->
</head>
<body>
    <!-- Header and Sidebar remain the same -->
    <!-- ... -->

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <h1 class="page-title">Dashboard</h1>
        
        <div class="dashboard-cards">
            <!-- Dashboard cards remain the same -->
            <!-- ... -->
        </div>
        
        <!-- Remove the Team Structure Section completely -->
        
        <!-- Transfer Funds Section remains the same -->
        <!-- ... -->
        
        <!-- Investment Packages Section remains the same -->
        <!-- ... -->
        
        <!-- Transaction History Section remains the same -->
        <!-- ... -->
    </main>

    <!-- Toast Notifications Container remains the same -->
    <!-- ... -->

    <!-- Login and Signup Modals remain the same -->
    <!-- ... -->

    <script type="module">
        // Previous imports and config remain the same
        // ...

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Previous setup code remains the same
            // ...

            // New function to load all user data
            loadAllUserData();
        });

        // New function to load all user data
        function loadAllUserData() {
            if (!currentUser) return;
            
            // Load main user data
            loadUserData(currentUser.uid);
            
            // Load transactions
            loadRecentTransactions();
            
            // Load invoices
            loadUserInvoices();
            
            // Load referrals
            loadReferralData();
        }

        // Modified loadUserData function
        function loadUserData(userId) {
            const userRef = ref(database, 'users/' + userId);
            
            onValue(userRef, (snapshot) => {
                userData = snapshot.val();
                if (userData) {
                    updateDashboardUI(userData);
                    localStorage.setItem('tradeWorldUser', JSON.stringify(userData));
                    
                    // Update side menu data
                    updateSideMenuData(userData);
                }
            }, (error) => {
                console.error("Error loading user data:", error);
            });
        }

        // New function to update side menu data
        function updateSideMenuData(data) {
            if (!data) return;
            
            // Update profile info in side menu
            document.getElementById('sideMenuUserName').textContent = data.name || 'User';
            document.getElementById('sideMenuUserBalance').textContent = `$${(data.balance || 0).toFixed(2)}`;
            
            // Update referral count
            const directRefCount = data.directReferrals ? Object.keys(data.directReferrals).length : 0;
            document.getElementById('sideMenuDirectRef').textContent = directRefCount;
            
            // Update team earnings
            document.getElementById('sideMenuTeamEarnings').textContent = `$${(data.teamEarnings || 0).toFixed(2)}`;
        }

        // New function to load referral data
        function loadReferralData() {
            if (!currentUser) return;
            
            const referralRef = ref(database, `users/${currentUser.uid}/directReferrals`);
            
            onValue(referralRef, (snapshot) => {
                const referrals = snapshot.val();
                if (referrals) {
                    // Calculate total referral earnings
                    calculateReferralEarnings(Object.keys(referrals));
                }
            });
        }

        // New function to calculate referral earnings
        async function calculateReferralEarnings(referralIds) {
            let totalEarnings = 0;
            
            for (const refId of referralIds) {
                const refSnapshot = await get(ref(database, `users/${refId}`));
                if (refSnapshot.exists()) {
                    const refData = refSnapshot.val();
                    totalEarnings += refData.referralEarnings || 0;
                }
            }
            
            // Update UI with total referral earnings
            document.getElementById('referralProfit').textContent = `$${totalEarnings.toFixed(2)}`;
            
            // Also update in user data
            if (userData) {
                userData.referralEarnings = totalEarnings;
                updateDashboardUI(userData);
            }
        }

        // New function to load user invoices
        function loadUserInvoices() {
            if (!currentUser) return;
            
            const invoicesRef = ref(database, `users/${currentUser.uid}/invoices`);
            
            onValue(invoicesRef, (snapshot) => {
                const invoices = snapshot.val();
                if (invoices) {
                    // Store invoices locally
                    localStorage.setItem('userInvoices', JSON.stringify(invoices));
                    
                    // You can process invoices here if needed
                }
            });
        }

        // Modified processPackagePurchase function to properly generate invoices
        async function processPackagePurchase(packageAmount) {
            if (!currentUser) {
                showToast('Please login first', 'error');
                return;
            }

            if ((userData.balance || 0) < packageAmount) {
                showToast('Insufficient balance', 'error');
                return;
            }

            try {
                // Create invoice with more details
                const invoiceId = push(ref(database, 'invoices')).key;
                const purchaseDate = Date.now();
                const maturityDate = purchaseDate + (30 * 24 * 60 * 60 * 1000); // 30 days later
                
                const invoiceData = {
                    invoiceId,
                    userId: currentUser.uid,
                    userName: userData.name || currentUser.email,
                    amount: packageAmount,
                    expectedReturn: packageAmount * 2,
                    purchaseDate: purchaseDate,
                    maturityDate: maturityDate,
                    status: 'active',
                    packageName: getPackageName(packageAmount),
                    transactions: [] // Will store all related transactions
                };
                
                // Calculate commissions and trading pool
                const adminCommission = packageAmount * COMMISSION_RATES.admin;
                const directReferralCommission = userData.referredBy ? packageAmount * COMMISSION_RATES.direct : 0;
                const levelCommissions = COMMISSION_RATES.levels.reduce((a, b) => a + b, 0) * packageAmount;
                const tradingPool = packageAmount - (adminCommission + directReferralCommission + levelCommissions);
                
                // Prepare all updates
                const updates = {};
                
                // 1. Deduct from user balance
                updates[`users/${currentUser.uid}/balance`] = (userData.balance || 0) - packageAmount;
                
                // 2. Add to investments
                updates[`users/${currentUser.uid}/investments/${invoiceId}`] = {
                    amount: packageAmount,
                    purchaseDate: purchaseDate,
                    status: 'active',
                    expectedReturn: packageAmount * 2,
                    maturityDate: maturityDate,
                    invoiceId: invoiceId
                };
                
                // 3. Add detailed invoice
                updates[`users/${currentUser.uid}/invoices/${invoiceId}`] = invoiceData;
                updates[`invoices/${invoiceId}`] = invoiceData;
                
                // 4. Add main transaction record
                const transactionId = push(ref(database, 'transactions')).key;
                const mainTransaction = {
                    type: 'investment',
                    amount: packageAmount,
                    status: 'completed',
                    timestamp: purchaseDate,
                    userId: currentUser.uid,
                    details: `Purchased ${invoiceData.packageName}`,
                    invoiceId: invoiceId
                };
                
                updates[`transactions/${transactionId}`] = mainTransaction;
                updates[`users/${currentUser.uid}/transactions/${transactionId}`] = mainTransaction;
                invoiceData.transactions.push(mainTransaction);
                
                // 5. Add admin commission (10%)
                const adminTransactionId = push(ref(database, 'transactions')).key;
                const adminTransaction = {
                    type: 'admin_commission',
                    amount: adminCommission,
                    status: 'completed',
                    timestamp: purchaseDate,
                    userId: ADMIN_ID,
                    details: `Commission from ${userData.name}'s package purchase`,
                    invoiceId: invoiceId
                };
                
                updates[`users/${ADMIN_ID}/balance`] = (await getValue(`users/${ADMIN_ID}/balance`)) + adminCommission;
                updates[`users/${ADMIN_ID}/transactions/${adminTransactionId}`] = adminTransaction;
                updates[`system/adminEarnings`] = (await getValue('system/adminEarnings')) + adminCommission;
                invoiceData.transactions.push({
                    ...adminTransaction,
                    forAdmin: true
                });
                
                // 6. Process referral commissions (if any)
                if (userData.referredBy) {
                    await processReferralCommissions(userData.referredBy, packageAmount, updates, invoiceId, purchaseDate);
                }
                
                // 7. Add to trading pool (70%)
                updates[`system/tradingPool`] = (await getValue('system/tradingPool')) + tradingPool;
                
                // 8. Update invoice with all transactions
                updates[`users/${currentUser.uid}/invoices/${invoiceId}/transactions`] = invoiceData.transactions;
                updates[`invoices/${invoiceId}/transactions`] = invoiceData.transactions;
                
                // Execute all updates
                await update(ref(database), updates);
                
                showToast(`Successfully purchased ${invoiceData.packageName}. Invoice #${invoiceId} generated.`, 'success');
                loadAllUserData();
                
            } catch (error) {
                console.error('Package purchase error:', error);
                showToast('Failed to purchase package', 'error');
            }
        }

        // Modified processReferralCommissions function to include invoice reference
        async function processReferralCommissions(referrerId, packageAmount, updates, invoiceId, timestamp, currentLevel = 1) {
            if (currentLevel > 5) return;

            // Get referrer data
            const referrerSnapshot = await get(ref(database, `users/${referrerId}`));
            if (!referrerSnapshot.exists()) return;
            
            const referrerData = referrerSnapshot.val();
            
            // Calculate commission based on level
            let commissionRate = 0;
            if (currentLevel === 1) {
                commissionRate = COMMISSION_RATES.direct; // 10% for direct referrer
            } else if (currentLevel <= 5) {
                commissionRate = COMMISSION_RATES.levels[currentLevel-2]; // 2% for levels 2-5
            }
            
            const commission = packageAmount * commissionRate;
            
            if (commission > 0) {
                // Update referrer's earnings
                updates[`users/${referrerId}/balance`] = (referrerData.balance || 0) + commission;
                updates[`users/${referrerId}/referralEarnings`] = (referrerData.referralEarnings || 0) + commission;
                updates[`users/${referrerId}/teamEarnings`] = (referrerData.teamEarnings || 0) + commission;
                
                // Add transaction record for referrer
                const transactionId = push(ref(database, 'transactions')).key;
                const referralTransaction = {
                    type: 'referral',
                    amount: commission,
                    status: 'completed',
                    timestamp: timestamp,
                    details: `Level ${currentLevel} referral commission`,
                    invoiceId: invoiceId,
                    fromUserId: currentUser.uid,
                    fromUserName: userData.name || currentUser.email
                };
                
                updates[`users/${referrerId}/transactions/${transactionId}`] = referralTransaction;
                
                // Add to invoice transactions
                updates[`invoices/${invoiceId}/transactions/${transactionId}`] = referralTransaction;
                updates[`users/${currentUser.uid}/invoices/${invoiceId}/transactions/${transactionId}`] = referralTransaction;
                
                // If referrer has an upline, continue recursively
                if (referrerData.referredBy && currentLevel < 5) {
                    await processReferralCommissions(referrerData.referredBy, packageAmount, updates, invoiceId, timestamp, currentLevel + 1);
                }
            }
        }

        // Previous remaining functions remain the same
        // ...
    </script>
</body>
</html>
