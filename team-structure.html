<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade World - Team Structure</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* (Your existing CSS remains exactly the same) */
    </style>
</head>
<body>
    <!-- (Your existing HTML structure remains the same until the scripts) -->

    <!-- Firebase and App Scripts -->
    <!-- Only use Firebase v8 (compatible) version -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBshAGZScyo7PJegLHMzORbkkrCLGD6U5s",
            authDomain: "mywebsite-600d3.firebaseapp.com",
            databaseURL: "https://mywebsite-600d3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywebsite-600d3",
            storageBucket: "mywebsite-600d3.firebasestorage.app",
            messagingSenderId: "584485288598",
            appId: "1:584485288598:web:01856eaa18ba5ada49e0b7",
            measurementId: "G-GQ9J9QH42J"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser = null;

        // DOM Elements (same as before)

        // Improved loadTeamStructure function
        async function loadTeamStructure(userId) {
            try {
                // Initialize level stats
                const levelStats = {
                    1: { count: 0, earnings: 0, members: [] },
                    2: { count: 0, earnings: 0, members: [] },
                    3: { count: 0, earnings: 0, members: [] },
                    4: { count: 0, earnings: 0, members: [] },
                    5: { count: 0, earnings: 0, members: [] }
                };
                
                // Clear the table
                teamMembersList.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading team members...</td></tr>';
                
                // First, get the user's direct referrals (Level 1)
                const directRefSnapshot = await database.ref('users').orderByChild('referredBy').equalTo(userId).once('value');
                const directRefs = directRefSnapshot.val() || {};
                
                levelStats[1].count = Object.keys(directRefs).length;
                
                // Process each direct referral and their downlines
                const processingPromises = [];
                
                for (const directRefId in directRefs) {
                    if (directRefs.hasOwnProperty(directRefId)) {
                        // Process Level 1 member
                        processingPromises.push(
                            processTeamMember(directRefId, 1, levelStats)
                        );
                        
                        // Get Level 2 (referrals of Level 1)
                        processingPromises.push(
                            getDownlineMembers(directRefId, 2, levelStats)
                        );
                    }
                }
                
                // Wait for all processing to complete
                await Promise.all(processingPromises);
                
                // Update the UI
                updateLevelStats(levelStats);
                renderTeamMembers(levelStats);
                
            } catch (error) {
                console.error('Error loading team structure:', error);
                showToast('Error loading team data', 'error');
                teamMembersList.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: red;">Error loading team data. Please try again.</td>
                    </tr>
                `;
            }
        }

        // Recursive function to get downline members
        async function getDownlineMembers(uplineId, currentLevel, levelStats) {
            if (currentLevel > 5) return;
            
            const snapshot = await database.ref('users').orderByChild('referredBy').equalTo(uplineId).once('value');
            const downlines = snapshot.val() || {};
            
            levelStats[currentLevel].count += Object.keys(downlines).length;
            
            const processingPromises = [];
            
            for (const downlineId in downlines) {
                if (downlines.hasOwnProperty(downlineId)) {
                    // Process this level member
                    processingPromises.push(
                        processTeamMember(downlineId, currentLevel, levelStats)
                    );
                    
                    // Get next level if not at level 5 yet
                    if (currentLevel < 5) {
                        processingPromises.push(
                            getDownlineMembers(downlineId, currentLevel + 1, levelStats)
                        );
                    }
                }
            }
            
            await Promise.all(processingPromises);
        }

        // Process team member data
        async function processTeamMember(userId, level, levelStats) {
            try {
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) return;
                
                // Calculate total investment
                let totalInvestment = 0;
                if (userData.investments) {
                    Object.values(userData.investments).forEach(investment => {
                        totalInvestment += parseFloat(investment.amount) || 0;
                    });
                }
                
                // Calculate earnings for this level (adjust commission % as needed)
                const commissionPercentage = [5, 4, 3, 2, 1][level - 1]; // 5% for L1, 4% for L2, etc.
                const earnings = totalInvestment * (commissionPercentage / 100);
                levelStats[level].earnings += earnings;
                
                // Format join date
                const joinDate = new Date(userData.joinDate || Date.now());
                const formattedDate = joinDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Get referrer name
                let referrerName = "Direct";
                if (userData.referredBy && userData.referredBy !== currentUser.uid) {
                    const referrerSnapshot = await database.ref(`users/${userData.referredBy}`).once('value');
                    const referrerData = referrerSnapshot.val();
                    referrerName = referrerData?.name || referrerData?.email || "Unknown";
                }
                
                // Add to members list for this level
                levelStats[level].members.push({
                    name: userData.name || userData.email || "Unknown",
                    level,
                    joinDate: formattedDate,
                    investment: totalInvestment,
                    earnings,
                    referredBy: referrerName
                });
                
            } catch (error) {
                console.error(`Error processing user ${userId}:`, error);
            }
        }

        // Render all team members in the table
        function renderTeamMembers(levelStats) {
            teamMembersList.innerHTML = '';
            
            // Combine all members from all levels
            const allMembers = [];
            for (let level = 1; level <= 5; level++) {
                allMembers.push(...levelStats[level].members);
            }
            
            if (allMembers.length === 0) {
                teamMembersList.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">No team members found</td>
                    </tr>
                `;
                return;
            }
            
            // Sort by level (optional)
            allMembers.sort((a, b) => a.level - b.level);
            
            // Add rows to table
            allMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td><span class="level-badge level-${member.level}">Level ${member.level}</span></td>
                    <td>${member.joinDate}</td>
                    <td>$${member.investment.toFixed(2)}</td>
                    <td>$${member.earnings.toFixed(2)}</td>
                    <td>${member.referredBy}</td>
                `;
                teamMembersList.appendChild(row);
            });
        }

        // (Rest of your existing functions remain the same)
    </script>
</body>
</html>
